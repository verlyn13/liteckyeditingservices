# Definitive Configuration and Integration Strategy for Biome v2.2.5

Last updated: 2025-10-12

## Introduction

This decision record pins Biome to v2.2.5 and adopts a canonical configuration that resolves prior hangs by scoping Biome to JS/TS/JSON only and using directory-level excludes. ESLint remains responsible for Astro/Svelte, and Prettier formats non-Biome targets.

## Canonical biome.jsonc (v2.2.5)

```jsonc
{
  "$schema": "https://biomejs.dev/schemas/2.2.5/schema.json",
  "root": true,
  "files": {
    "includes": [
      "src/**/*.{ts,tsx,js,mjs,cjs,json,jsonc}",
      "workers/**/*.{ts,tsx,js,mjs,cjs,json,jsonc}",
      "functions/**/*.{ts,tsx,js,mjs,cjs,json,jsonc}",
      "tests/**/*.{ts,tsx,js,mjs,cjs,json,jsonc}",
      "scripts/**/*.{ts,tsx,js,mjs,cjs,json,jsonc}",
      "config/**/*.{ts,tsx,js,mjs,cjs,json,jsonc}",
      "*.{js,ts,mjs,cjs,json,jsonc}",
      "!node_modules",
      "!dist",
      "!build",
      "!.wrangler",
      "!.astro",
      "!.svelte-kit",
      "!.next",
      "!.vercel",
      "!coverage",
      "!playwright-report",
      "!test-results",
      "!public",
      "!_archive",
      "!.git",
      "!.mise",
      "!tmp",
      "!**/*.astro",
      "!**/*.svelte",
      "!**/*.vue",
      "!src/admin/cms-config.ts"
    ],
    "maxSize": 1048576,
    "ignoreUnknown": true
  },
  "vcs": {
    "enabled": true,
    "clientKind": "git",
    "useIgnoreFile": true,
    "defaultBranch": "main"
  },
  "formatter": { "enabled": true },
  "linter": {
    "enabled": true,
    "rules": {
      "recommended": true,
      "suspicious": {
        "noExplicitAny": "warn",
        "noAssignInExpressions": "warn",
        "useIterableCallbackReturn": "warn"
      }
    }
  }
}
```

### Configuration Explanation

- **`root: true`** - Prevents Biome from searching parent directories for additional config files
- **`files.includes`** - Explicit glob patterns for JS/TS/JSON files in source directories
- **`!node_modules`, `!dist`, etc.** - Directory-level exclusions (no trailing slash needed in v2.2.5)
- **`!**/*.astro`, `!**/*.svelte`, `!**/*.vue`** - Explicit framework file exclusions (handled by Prettier/ESLint)
- **`!src/admin/cms-config.ts`** - Exclude generated files that shouldn't be formatted
- **`maxSize: 1048576`** - Skip files larger than 1MB (prevents processing large bundles)
- **`ignoreUnknown: true`** - Don't error on file types Biome doesn't understand
- **`vcs.enabled: true`** - Git integration to respect `.gitignore` patterns
- **`vcs.useIgnoreFile: true`** - Automatically exclude git-ignored files

## Updated package.json Scripts

```json
{
  "scripts": {
    "biome:check": "biome check --write .",
    "biome:fix": "biome check --write .",
    "biome:triage": "biome ci --reporter=summary .",
    "biome:triage:json": "biome ci --reporter=json-pretty .",
    "biome:ci": "biome ci .",
    "biome:ci:changed": "biome ci --changed main --reporter=summary",
    "biome:changed": "biome check --changed --write",
    "check": "pnpm run clean && pnpm run validate:all && pnpm run biome:check && pnpm run typecheck && pnpm run format"
  },
  "devDependencies": {
    "@biomejs/biome": "2.2.5"
  }
}
```

### Script Descriptions

- **`biome:check`** - Local development: format, lint, and auto-fix all files (write mode)
- **`biome:fix`** - Alias for `biome:check` for consistency with other tools
- **`biome:triage`** - Human-readable summary report showing all issues (read-only)
- **`biome:triage:json`** - JSON output for tooling/CI integration
- **`biome:ci`** - CI/CD mode: fails on any issues, never writes files
- **`biome:ci:changed`** - Check only files changed from main branch (PR hygiene)
- **`biome:changed`** - Fix only files changed from main branch (fast local fixes)
- **`check`** - Full validation pipeline including Biome

## Root Cause Analysis (Hanging)

Legacy deep-negative patterns (e.g., `!dist/**`) and `experimentalScannerIgnores` force the scanner to traverse directories before ignoring contents. In v2.2.5, use directory-level excludes (`!dist`, `!node_modules`, etc.) so Biome skips entire folders without crawling them. This removes the source of the performance collapse.

Note: Biome v2.2.5 does not require trailing slashes on directory exclusions. Both `!dist/` and `!dist` work correctly.

## Implementation Issues Discovered

### Biome Processing Framework Files

**Problem**: Initial implementation allowed Biome to process `.astro` and `.svelte` files, corrupting them by removing frontmatter fences and treating framework-specific syntax as JavaScript.

**Solution**: Added explicit exclusions to `files.includes`:
```jsonc
"!**/*.astro",
"!**/*.svelte",
"!**/*.vue"
```

**Why needed**: The file extension globs (`*.{ts,tsx,js,...}`) alone weren't sufficient. Biome's file detection heuristics would still attempt to process framework files found during directory traversal.

### FileUpload Component Bug

**Problem**: `src/components/FileUpload.svelte` had undefined variable references causing production build failures:
- Template referenced `onChange` but function was named `_onChange`
- Template referenced `error` but variable was named `_error`

**Error**: `error is not defined` at `contact.astro.mjs:254:7`

**Solution**: Updated template to use correct variable names (`_onChange`, `_error`). This was a pre-existing bug exposed when framework file exclusions were added.

### Generated File Exclusion

**Problem**: `src/admin/cms-config.ts` is generated by `scripts/build-cms-config.mjs` and should not be formatted by Biome.

**Solution**: Added explicit exclusion: `"!src/admin/cms-config.ts"`

**Best Practice**: Always exclude generated files from formatters to prevent check/format cycles in CI.

## References

- Configuration | Biome — https://biomejs.dev/reference/configuration/
- Configure Biome — https://biomejs.dev/guides/configure-biome/
- useBiomeIgnoreFolder — https://biomejs.dev/linter/rules/use-biome-ignore-folder/
- Upgrade to Biome v2 — https://biomejs.dev/guides/upgrade-to-biome-v2/

